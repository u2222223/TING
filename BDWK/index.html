<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <title>TING下载助手</title>
    <link rel="preload" as="style" href="./style.css" />
    <link rel="modulepreload" href="./index.js" />
    <link rel="stylesheet" href="./style.css" />
    <script type="module" src="./index.js"></script>
    <link rel="stylesheet" href="https://at.alicdn.com/t/c/font_3620686_jhcgofk779.css" />
    <script src="./static/js/jquery-3.7.1.min.js"></script>
    <script>
        // 检查是否成功加载了jQuery
        window.jQuery || document.write('<script src="./static/js/jquery-3.7.1.min.js"><\\/script>')
    </script>
    <script src="./static/js/jspdf.umd.min.js"></script>
</head>

<body>
    <header class="header"></header>
    <section>
        <div class="card-main">
            <div class="card-head">
                <span class="card-head-title">
                    TING下载助手
                </span>
            </div>
            <div class="card-body">
                <div class="wenku-container">
                    <!-- <div class="notice">
                        免责声明:本工具仅为方便查看在线文档和交流技术使用
                    </div> -->
                    <div class="input">
                        <textarea class="mobile" placeholder="请输入BD文档链接" cols="30" rows="10"></textarea>
                        <input id="link" class="webv" value="" autocomplete="off" type="text" placeholder="请输入BD文档链接">
                        <button type="button" class="bd_click">获取网页数据</button>
                    </div>
                    <div style="clear:both;"></div>
                    <div class="docsinfo">
                    </div>
                    <div class="s-top">
                        <div class="s-panel">
                            <div class="s-progress-wrapper">
                                <div class="s-progress"></div>
                            </div>
                            <div class="s-status">
                                <div class="s-text">正在加载...</div>
                                <div class="s-progress-text">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="s-top-message">
                        <div class="s-message">msg</div>
                    </div>
                    <div class="s-top-verifycode">
                        <p class="tips">防止恶意请求，请输入验证码</p>
                        <img src="https://res.mounui.com/info/wechat_jam_qrcode.jpg">
                        <p style="font-size: 14px;color:#666;margin-bottom: 20px;">微信关注上方公众号，回复"6"获取</p>
                        <div class="verify-item">
                            <span class="item-title">验证码：</span>
                            <input type="text" placeholder="请输入验证码" id="code" autocomplete="off" class="input-inline">
                        </div>
                        <div><button style="background:#bcbcbc;" type="button" class="close_jam">关闭</button><button
                                type="button" class="tj_jam">提交</button></div>
                        <div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <footer>
        <!-- 免责声明 -->
        <div class="footer-content">
            <p>免责声明：本工具完全免费仅供学习和交流使用，不得用于任何商业用途，使用本工具下载的任何内容的版权归原作者所有。</p>
        </div>
    </footer>
    <div class="loader">
        <div class="loader-inner">
            <div class="loader-line-wrap">
                <div class="loader-line"></div>
            </div>
            <div class="loader-line-wrap">
                <div class="loader-line"></div>
            </div>
            <div class="loader-line-wrap">
                <div class="loader-line"></div>
            </div>
            <div class="loader-line-wrap">
                <div class="loader-line"></div>
            </div>
            <div class="loader-line-wrap">
                <div class="loader-line"></div>
            </div>
        </div>
        <div class="loadmsg">
            正在获取网页数据，请勿操作!
        </div>
    </div>
</body>
<script>
    /* 全局状态 */
    let readerInfo = null;
    /* UI：显示“正在获取”提示 */
    function showLoaderMessage(text) {
        $('.loadmsg').html(text);
        $('.loader').show();
    }

    // 从URL查询参数中提取url值并填充到输入框
    function populateUrlFromQuery() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlParam = urlParams.get('url');

        if (urlParam) {
            const mobileInput = document.querySelector('.mobile');
            const webInput = document.querySelector('.webv');

            const decodedUrl = decodeURIComponent(urlParam);
            if (mobileInput) mobileInput.value = decodedUrl;
            if (webInput) webInput.value = decodedUrl;
        }
    }
    document.addEventListener('DOMContentLoaded', populateUrlFromQuery);

    /* UI：顶部浮动提示 */
    let messageTimer = null;
    function showToast(content, duration = 3000) {
        const bar = document.querySelector('.s-top-message');
        if (!content) {
            bar.classList.remove('show');
            return;
        }
        bar.classList.add('show');
        document.querySelector('.s-top-message .s-message').innerHTML = content;
        clearTimeout(messageTimer);
        messageTimer = setTimeout(() => bar.classList.remove('show'), duration);
    }

    /* UI：验证码弹窗 */
    function openVerifyModal() {
        document.querySelector('.s-top-verifycode').classList.add('show');
    }
    function closeVerifycode() {
        document.querySelector('.s-top-verifycode').classList.remove('show');
    }

    $(".bd_click").click(fetchDocument);
    $(".close_jam").click(closeVerifycode);
    $(".tj_jam").click(fetchDocument);
    /* 主流程：获取文档信息 */
    async function fetchDocument() {
        let urlInput;
        const screenWidth = window.innerWidth;
        if (screenWidth <= 768) {
            urlInput = document.querySelector('.mobile').value.trim();
        } else {
            urlInput = document.querySelector('.webv').value.trim();
        }

        if (!urlInput) {
            showToast('您还没有输入文档链接哦！');
            return;
        }

        showLoaderMessage('正在获取网页数据，需要一些时间，请耐心等待...');
        document.querySelector('.bd_click').setAttribute('disabled', 'disabled');
        fetch("http://localhost:3000/baiduwenku/getData", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                url: urlInput
            })
        }).then(res => res.json())
            .then(res => {
                if (res.code === 0) {
                    const fileType = res.file_type;
                    readerInfo = res.readerinfo;
                    let commHtml = `<div class="item"><span class="item-title">文档ID:</span><span class="item-info">${readerInfo.docId}</span></div>
                <div class="item"><span class="item-title">文档名称:</span><span class="item-info doc-title">${res.title}</span></div>
                <div class="item"><span class="item-title">总页数:</span><span class="item-info">共${readerInfo.page}页</span>
                <span class="item-title">可下载页数:</span><span class="item-info">${readerInfo.showPage}页</span></div>`;
                    if (fileType === 'txt') {
                        window.txtinfo = {
                            title: res.title,
                            text: res.docdata
                        }
                        document.querySelector(".docsinfo").innerHTML = commHtml + `<div class="downline"><button type="button" class="downbtn" onclick="savetxt()">下载</button></div>`;
                    } else if (["excel", "ppt", "word", "pdf"].includes(fileType)) {
                        const pageNodes = buildReaderPages(readerInfo, res.docdata);
                        window.wordinfo = { title: res.title, data: res.docdata };
                        window.ceader = { readerinfo: readerInfo, readerpages: pageNodes };
                        document.querySelector('.docsinfo').innerHTML = commHtml + `
                <div class="downline">
                  <label class="item-title">分批下载:</label>
                  <div class="input-inline">
                    <input id="start" type="number" placeholder="开始">
                    <span style="line-height: 38px;margin: 0 10px;">-</span>
                    <input id="end" type="number" placeholder="结束">
                  </div>
                <button type="button" class="downbtn" onclick="savedocs()">下载PDF</button>
                </div>`;
                    } else {
                        showToast(`暂不支持下载${fileType}格式文件`);
                    }
                } else {
                    let msg = '异常，请将链接发送给管理员';
                    showToast(msg);
                }
            }).catch(err => {
                console.log(err);
            }).finally(() => {
                $('.loader').hide();
                document.querySelector('.bd_click').removeAttribute('disabled');
                closeVerifycode();
            });
    }

    window.savetxt = function () {
        let e = window.txtinfo
            , o = e.text
            , t = new Blob([o], {
                type: "text/plain"
            })
            , s = document.createElement("a");
        s.download = e.title + ".txt",
            s.href = window.URL.createObjectURL(t),
            s.target = "_blank",
            s.style.display = "none",
            document.body.appendChild(s),
            s.click(),
            document.body.removeChild(s)
    }
    /* 构造 readerPages，供 PDF 导出使用 */
    function buildReaderPages(info, docData) {
        let pages = [];
        if (docData && info?.htmlUrls?.json) {
            let pngDataCache = info.htmlUrls.png || [];
            for (let pageIdx = 0; pageIdx < docData.length; pageIdx++) {
                let node = {
                    index: pageIdx + 1,
                    nodes: '',
                    picsrc: '',
                    readerinfo: info
                };
                if (docData[pageIdx]) {
                    // 绑定对应 PNG 地址
                    for (let pngItem of pngDataCache) {
                        if (pngItem.pageIndex - 1 === pageIdx) {
                            docData[pageIdx].picsrc = pngItem.pageLoadUrl;
                            node.picsrc = pngItem.pageLoadUrl;
                        }
                    }
                    // 根据是否有 ttf 决定节点类型
                    if (info.htmlUrls.ttf) {
                        node.nodes = buildWordNodes(docData[pageIdx]);
                    } else {
                        node.nodes = buildPicNodes(info, docData[pageIdx]);
                    }
                }
                pages.push(node);
            }
        } else {
            // 纯图片模式
            info.htmlUrls.ttf = [];
            for (let idx = 0; idx < info.htmlUrls.length; idx++) {
                pages[idx] = {
                    index: idx + 1,
                    nodes: [],
                    picsrc: info.htmlUrls[idx],
                    readerinfo: info
                };
                const picNode = {
                    matrix: null,
                    picPos: { ih: info.pageInfo.pageHeight, iw: info.pageInfo.pageWidth, ix: 0, iy: 0 },
                    pos: {
                        h: info.pageInfo.pageHeight,
                        opacity: 1,
                        w: info.pageInfo.pageWidth,
                        x: '',
                        y: '',
                        z: ''
                    },
                    scaleX: 1,
                    scaleY: 1,
                    src: info.htmlUrls[idx],
                    type: 'pic'
                };
                pages[idx].nodes.push(picNode);
            }
        }
        return pages;
    }

    /* 纯图片模式节点 */
    function buildPicNodes(info, pageData) {
        const body = pageData.body || [];
        const result = [];
        for (const item of body) {
            if (item.t === 'pic') {
                result.push({
                    matrix: null,
                    picPos: { ih: pageData.page.ih, iw: pageData.page.iw, ix: 0, iy: 0 },
                    pos: { h: info.pageInfo.pageHeight, opacity: 1, w: info.pageInfo.pageWidth, x: '', y: '', z: '' },
                    src: pageData.picsrc,
                    type: 'pic'
                });
            }
        }
        return result;
    }

    /* 文本模式节点 */
    function buildWordNodes(pageData) {
        const body = pageData.body;
        const style = pageData.style;
        const nodes = [];
        for (const item of body) {
            if (item.t === 'word' && item.c !== ' ') {
                const node = {
                    type: 'word',
                    content: item.c,
                    pos: item.p,
                    matrix: null,
                    scaleX: item.ps?._scaleX ?? 1,
                    scaleY: item.ps?._scaleY ?? 1,
                    fontStyle: 'normal',
                    fontWeight: 400,
                    letterSpacing: 0,
                    ...(item.s ? {
                        color: item.s.color,
                        fontFamily: item.s['font-family'],
                        fontSize: item.s['font-size'],
                        letterSpacing: item.s['letter-spacing']
                    } : {})
                };
                // 处理样式表
                if (item.r && style) {
                    for (const st of style) {
                        const indices = st.c;
                        for (const idx of item.r) {
                            if (indices.includes(idx)) {
                                if (st.s['font-size']) node.fontSize = st.s['font-size'];
                                if (st.s.bold) node.fontWeight = 700;
                                if (st.s['font-family']) node.fontFamily = st.s['font-family'];
                                if (st.s.color) node.color = st.s.color;
                                if (st.s['letter-spacing']) node.letterSpacing = st.s['letter-spacing'];
                            }
                        }
                    }
                }
                nodes.push(node);
            } else if (item.t === 'pic') {
                nodes.push({
                    type: 'pic',
                    picPos: item.c,
                    pos: item.p,
                    src: pageData.picsrc
                });
            }
        }
        return nodes;
    }

    /* ---------- 下载 PDF ---------- */
    window.savedocs = function () {
        // 标记：脚本正在运行（防止微信劫持）
        window.localStorage.setItem('isScript', true);

        const readerData = window.ceader;

        /* ------ 更新进度条 ------ */
        const updateProgress = (text = '', percent = -1) => {
            const topPanel = document.querySelector('.s-top');
            topPanel.classList.add('show');
            if (text) document.querySelector('.s-panel .s-text').textContent = text;
            if (percent >= 0) {
                percent = Math.min(percent, 100);
                const bar = document.querySelector('.s-panel .s-progress');
                bar.style.width = `${Math.floor(percent)}%`;
                bar.textContent = `${Math.floor(percent)}%`;
                // 修改s-progress-text的内容
                const progressText = document.querySelector('.s-panel .s-progress-text');
                progressText.textContent = `${Math.floor(percent)}%`;
            }
        };

        // 关闭进度条
        const closeProgress = () => document.querySelector('.s-top').classList.remove('show');

        /* ------ 网络请求 ------ */
        const request = (method, url, body, type = 'text') =>
            new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(method, url, true);
                xhr.responseType = type;
                xhr.send(body);
                xhr.onload = () => xhr.readyState === 4 && resolve(xhr.response);
                xhr.onerror = () => reject(new Error('Network error'));
            });

        /* ------ 图片缓存 ------ */
        const loadImage = async src => {
            if (!src) return null;
            const blob = await request('GET', src, null, 'blob');
            if (!blob.type.startsWith('image/')) return null;
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.referrerPolicy = 'no-referrer';
            return new Promise((resolve, reject) => {
                img.onerror = img.onabort = () => reject(new Error('Image load error'));
                img.onload = () => resolve(img);
                img.src = URL.createObjectURL(blob);
            });
        };

        /* ------ 字体加载 ------ */
        const loadFonts = async (d, m) => {
            const i = "https://wkretype.bdimg.com/retype";
            let l = ["pn=" + m.index, "t=ttf", "rn=1", "v=" + m.readerinfo.pageInfo.version].join("&"),
                c = m.readerinfo.htmlUrls.ttf.find(u => u.pageIndex === m.index);
            if (!c) return;
            let w = encodeURI(i + "/pipe/" + m.readerinfo.storeId + "?" + l + c.param),
                f = await request("GET", w);
            if (!f) return;
            f = f.replace(/[\n\r ]/g, "");
            let h = [],
                g = f.matchAll(/@font-face{[^{}]+}/g);
            for (const u of g) {
                const _ = u[0].match(/url\(["']?([^"']+)["']?\)/),
                    S = u[0].match(/font-family:["']?([^;'"]+)["']?;/),
                    I = u[0].match(/font-style:([^;]+);/),
                    b = u[0].match(/font-weight:([^;]+);/);
                if (!_ || !S) throw new Error("failed to parse font");
                h.push({
                    name: S[1],
                    style: I ? I[1] : "normal",
                    weight: b ? b[1] : "normal",
                    base64: _[1]
                })
            }
            for (const u of h) d.addFileToVFS(`${u.name}.ttf`, u.base64.slice(u.base64.indexOf(",") + 1)), d.addFont(`${u.name}.ttf`, u.name, u.style, u.weight)
        };

        /* ------ 页码范围辅助 ------ */
        const range = (start, end) => Array.from({ length: end - start + 1 }, (_, i) => i + start);

        /* ------ 渲染单页 ------ */
        const renderItem = async (pdf, page, item) => {
            if (item.type === 'word') {
                pdf.setFont(item.fontFamily || 'helvetica', item.fontStyle || 'normal');
                pdf.setTextColor(item.color || '#000');
                pdf.setFontSize(item.fontSize || 12);
                const options = { charSpace: item.letterSpacing || 0, baseline: 'top' };
                const matrix = new pdf.Matrix(
                    item.matrix?.a ?? item.scaleX ?? 1,
                    item.matrix?.b ?? 0,
                    item.matrix?.c ?? 0,
                    item.matrix?.d ?? item.scaleY ?? 1,
                    item.matrix?.e ?? 0,
                    item.matrix?.f ?? 0
                );
                pdf.text(item.content, item.pos.x, item.pos.y, options, matrix);
            } else if (item.type === 'pic') {
                let img = page._pureImg;
                if (!img) {
                    console.debug('[+] page._pureImg undefined, loading...');
                    img = await loadImage(item.src);
                    if (!img) return;
                }
                const [w, h] = [item.pos.w || 0, item.pos.h || 0];
                const canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                if (item.pos.opacity && item.pos.opacity !== 1) ctx.globalAlpha = item.pos.opacity;
                if (item.scaleX && item.scaleX !== 1) ctx.scale(item.scaleX, item.scaleY);
                if (item.matrix) {
                    const m = item.matrix;
                    ctx.transform(m.a ?? 1, m.b ?? 0, m.c ?? 0, m.d ?? 1, m.e ?? 0, m.f ?? 0);
                }
                ctx.drawImage(img, item.picPos.ix, item.picPos.iy, item.picPos.iw, item.picPos.ih, 0, 0, w, h);
                pdf.addImage(canvas, 'PNG', item.pos.x ?? 0, item.pos.y ?? 0, w, h);
                canvas.remove();
            }
        };
        /* ------ 导出核心 ------ */
        const exportPages = async (range) => {
            const showPages = [...Array(readerData.readerinfo.showPage).keys()];
            const pagesToExport = range || showPages;
            updateProgress('正在准备', 0);

            let pdf = null;
            for (let i = 0; i < pagesToExport.length; i++) {
                const pageIndex = pagesToExport[i];
                if (pageIndex >= readerData.readerpages.length) {
                    console.warn('[!] pageRange[i] >= readerpages.length, skip...');
                    continue;
                }
                const page = readerData.readerpages[pageIndex];
                const [width, height] = [parseInt(page.readerinfo.pageInfo.pageWidth), parseInt(page.readerinfo.pageInfo.pageHeight)];
                if (!pdf) {
                    pdf = new jspdf.jsPDF({
                        orientation: width < height ? 'p' : 'l',
                        unit: 'pt',
                        format: [width, height],
                        compress: true
                    });
                } else {
                    pdf.addPage([width, height], width < height ? 'p' : 'l');
                }

                updateProgress('正在下载图片', ((i + 1) / pagesToExport.length) * 100);
                page._pureImg = await loadImage(page.picsrc);
                updateProgress('正在加载字体', ((i + 1) / pagesToExport.length) * 100);
                await loadFonts(pdf, page);
                updateProgress('正在绘制', ((i + 1) / pagesToExport.length) * 100);
                for (const item of page.nodes) {
                    await renderItem(pdf, page, item);
                }
                // 清理内存
                if (page._pureImg?.src) URL.revokeObjectURL(page._pureImg.src);
                page._pureImg?.remove?.();
            }
            const title = document.querySelector('.doc-title')?.textContent || 'document';
            pdf.save(`${title}.pdf`);
        };

        /* ------ 主流程 ------ */
        (async () => {
            try {
                let pageRange;
                let exportCount = 0;
                const startVal = document.querySelector('#start').value.trim();
                const endVal = document.querySelector('#end').value.trim();
                if (startVal && endVal) {
                    const start = parseInt(startVal, 10);
                    const end = parseInt(endVal, 10);
                    if (start > end) throw new Error('结束页码必须大于开始页码');
                    if (end > readerData.readerinfo.showPage || start < 1) throw new Error('页码输入错误');
                    pageRange = range(start - 1, end - 1);
                    exportCount = pageRange.length;
                } else {
                    pageRange = null;
                    exportCount = readerData.readerinfo.showPage;
                }
                document.querySelector('.downbtn').setAttribute('disabled', 'disabled');
                await exportPages(pageRange);
                showToast(`已成功导出，共计 ${exportCount} 页~`);
            } catch (err) {
                console.error('[x] export failed:', err);
                showToast(`导出失败：${err.message}`);
            } finally {
                closeProgress();
                document.querySelector('.downbtn').removeAttribute('disabled');
            }
        })();
    };
    (/MicroMessenger/i).test(navigator.userAgent) ? $("body").addClass("mask") : console.log("这不是在微信内打开的网页");
</script>

</html>